<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Libro — Na Books</title>
<style>
  :root{
    /* Tamaño real del libro 4x6 pulgadas pero escalado grande */
    --inch: 96px; /* referencia estándar aproximada */
    --book-w: calc(4 * var(--inch) * 1.4);  /* escalado 140% */
    --book-h: calc(6 * var(--inch) * 1.4);

    --bg:#f2f2f3;
    --page-bg:#fff;
    --accent:#222;
    --muted:#666;
    --shadow: 0 10px 30px rgba(0,0,0,0.15);
  }
  html,body{margin:0;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;font-family:Inter, sans-serif;}

  .book{
    width:var(--book-w);
    height:var(--book-h);
    background:var(--page-bg);
    box-shadow:var(--shadow);
    border-radius:8px;
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .page-area{
    flex:1;
    overflow:hidden;
    position:relative;
  }

  .page{
    width:100%;
    height:100%;
    overflow:hidden;
    padding:36px;
    box-sizing:border-box;
    position:relative;
  }

  .page-inner{
    width:100%;
    box-sizing:border-box;
    color:var(--accent);
  }

  .footer{
    height:48px;
    border-top:1px solid #ddd;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 18px;
    box-sizing:border-box;
    background:#fafafa;
    font-size:14px;
  }

  /* Tipografía */
  h1{font-size:26px;margin:12px 0 16px;}
  h2{font-size:22px;margin:10px 0 14px;}
  p{font-size:16px;line-height:1.55;margin:12px 0;}
  img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:6px;}

  /* Portada centrada */
  .cover {
    width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;
  }
  .cover img {max-height:90%;object-fit:contain;}
  .cover-title{font-size:32px;font-weight:700;margin-top:12px;text-align:center;}
  .cover-author{font-size:18px;color:var(--muted);margin-top:4px;text-align:center;}

  /* Controles */
  .controls{margin-top:16px;display:flex;gap:8px;justify-content:center;}
  button{padding:8px 14px;border:1px solid #ccc;border-radius:6px;font-weight:600;background:white;cursor:pointer;}

  /* Overlay */
  .overlay{position:absolute;inset:0;background:rgba(255,255,255,0.85);display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;box-sizing:border-box;}
  .hidden{display:none;}
</style>
</head>
<body>

<div class="book">
  <div class="page-area">
    <div id="page" class="page">
      <div id="page-inner" class="page-inner">Cargando…</div>
    </div>
  </div>
  <div class="footer">
    <span>Na Books</span>
    <span id="pageNumber">0 / 0</span>
  </div>
  <div id="overlay" class="overlay hidden"><div id="overlayMsg"></div></div>
</div>

<div class="controls">
  <button id="firstBtn">Portada</button>
  <button id="prevBtn">◀</button>
  <button id="nextBtn">▶</button>
  <button id="lastBtn">Contraportada</button>
</div>

<script>
const PAGE_WIDTH = 4 * 96 * 1.4;
const PAGE_HEIGHT = 6 * 96 * 1.4;

let rawPages = [];
let pages = [];
let current = 0;
let mdURL = "https://bynashi.qzz.io/data/ASATRU/LIBRO.md";
const COVER_URL = "https://bynashi.qzz.io/data/ASATRU/Senderos%20del%20Norte/front.png";

const pageInner = document.getElementById("page-inner");
const pageNum = document.getElementById("pageNumber");
const overlay = document.getElementById("overlay");
const overlayMsg = document.getElementById("overlayMsg");

function showOverlay(msg){overlayMsg.innerHTML = msg;overlay.classList.remove("hidden");}
function hideOverlay(){overlay.classList.add("hidden");}

function splitByMandatoryPages(md){
  const lines = md.split(/\r?\n/);
  let list = [];
  let cur = [];
  for(let l of lines){
    if(/^\s*---\s*$/.test(l)){ list.push(cur.join("\n")); cur=[]; }
    else cur.push(l);
  }
  list.push(cur.join("\n"));
  return list;
}

/* Conversor Markdown básico */
function mdToHTML(md){
  md = md.replace(/```([\s\S]*?)```/g, (m,c)=>"<pre><code>"+c.replace(/[&<>]/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]))+"</code></pre>");

  md = md.replace(/^# (.*)$/gm, "<h1>$1</h1>")
         .replace(/^## (.*)$/gm, "<h2>$1</h2>")
         .replace(/^> (.*)$/gm, "<blockquote>$1</blockquote>")
         .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
         .replace(/\*(.*?)\*/g,"<em>$1</em>")
         .replace(/`([^`]+)`/g,"<code>$1</code>")
         .replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1">')
         .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1<\/a>');

  md = md.split(/\n{2,}/).map(p=>"<p>"+p.replace(/\n/g,"<br>")+"</p>").join("\n");
  return md;
}

/* Auto: si el contenido es demasiado alto, dividir dinámicamente */
function autoPaginate(html){
  // More robust pagination: measure nodes and avoid relying on outerHTML on text nodes
  const meas = document.createElement('div');
  meas.style.position = 'absolute';
  meas.style.visibility = 'hidden';
  meas.style.width = (PAGE_WIDTH - 36*2) + 'px';
  meas.style.padding = '0';
  meas.style.boxSizing = 'border-box';
  document.body.appendChild(meas);

  meas.innerHTML = html;
  const children = Array.from(meas.childNodes);
  const pagesOut = [];
  let frag = document.createElement('div');

  function fragmentOverflows(testFrag){
    const tester = document.createElement('div');
    tester.style.visibility = 'hidden';
    tester.style.position = 'absolute';
    tester.style.width = (PAGE_WIDTH - 36*2) + 'px';
    tester.style.padding = '36px';
    tester.style.boxSizing = 'border-box';
    tester.innerHTML = testFrag.innerHTML;
    document.body.appendChild(tester);
    const over = tester.scrollHeight > (PAGE_HEIGHT - 48);
    tester.remove();
    return over;
  }

  for(const node of children){
    // for text nodes, wrap in <p>
    let toAppend;
    if(node.nodeType === Node.TEXT_NODE){
      const text = node.textContent.trim();
      if(text === '') continue;
      toAppend = document.createElement('p');
      toAppend.textContent = text;
    } else {
      toAppend = node.cloneNode(true);
    }

    frag.appendChild(toAppend);
    if(fragmentOverflows(frag)){
      // remove last appended
      frag.removeChild(frag.lastChild);
      // push current frag
      pagesOut.push(frag.innerHTML);
      // start new frag with the node that didn't fit
      frag = document.createElement('div');
      frag.appendChild(toAppend.cloneNode(true));

      // if single element still overflows, push it anyway (avoid infinite loop)
      if(fragmentOverflows(frag)){
        pagesOut.push(frag.innerHTML);
        frag = document.createElement('div');
      }
    }
  }

  if(frag.innerHTML.trim().length>0) pagesOut.push(frag.innerHTML);
  meas.remove();
  return pagesOut;
}

function buildPages(){
  pages = [];

  /* Portada */
  pages.push(
    `<div class=\"cover\">
       <img src=\"${COVER_URL}\" alt=\"Portada\" onerror=\"this.remove();document.querySelector('.cover').innerHTML='<div class=cover-title>Portada</div>';\" />
       <div class=\"cover-author\">Na Books</div>
    </div>`
  );

  /* Índice configurable por el usuario */
  const userTOC = window.userTOC || [];
  // userTOC should be array of {title, page}
  let tocHTML = '<h1>Índice</h1><ul>' + (userTOC.map ? userTOC.map(i=>`<li><a href="#" class="toc-link" data-page="${i.page}">${i.title}</a> — página ${i.page}</li>`).join('') : '') + '</ul>';
  pages.push(tocHTML);


  /* Contenido */ 
  rawPages.forEach(section=>{
    const html = mdToHTML(section);
    const splitted = autoPaginate(html);
    pages.push(...splitted);
  });

  /* Contraportada */
  pages.push(`<div class="cover"><div class="cover-title">Contraportada</div><div class="cover-author">Na Books</div></div>`);
}

// Attach listeners to TOC links (click to navigate)
function attachTOCListeners(){
  document.querySelectorAll('.toc-link').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      const p = parseInt(a.getAttribute('data-page'),10);
      if(!isNaN(p)) renderPage(p-1);
    });
  });
}

function renderPage(i){
  current = Math.max(0, Math.min(i, pages.length-1));
  pageInner.innerHTML = (pages[current] || '').replace(/undefined/g, '');
  pageNum.textContent = `${current+1} / ${pages.length}`;
}

async function loadMD(){
  showOverlay("Cargando libro...");
  try{
    const r = await fetch(mdURL);
    const t = await r.text();
    rawPages = splitByMandatoryPages(t);
    buildPages();
    attachTOCListeners();
    hideOverlay();
    renderPage(0);
  }catch(e){
    showOverlay("Error al cargar el libro: "+e);
  }
}

/* Controles */
document.getElementById("nextBtn").onclick = ()=>renderPage(current+1);
document.getElementById("prevBtn").onclick = ()=>renderPage(current-1);
document.getElementById("firstBtn").onclick = ()=>renderPage(0);
document.getElementById("lastBtn").onclick = ()=>renderPage(pages.length-1);

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowRight") renderPage(current+1);
  if(e.key==="ArrowLeft") renderPage(current-1);
});

loadMD();
</script>
</body>
</html>
